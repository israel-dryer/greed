@if (playService.activeGame(); as game) {
  <ion-header [translucent]="false">
    <ion-toolbar >
      <ion-title>Round {{ getRoundNumber() }}</ion-title>
      <ion-text slot="end" color="medium" style="padding-right: 1rem;">
        <span *ngIf="elapsedHours > 0">{{ elapsedHours | number: "1.0-0" }}:</span>
        <span>{{ elapsedMinutes | number: "2.0-0" }}:</span>
        <span>{{ elapsedSeconds | number: "2.0-0" }}</span>
      </ion-text>
    </ion-toolbar>
  </ion-header>

  <ion-content [fullscreen]="true">
    <div class="play-container">
      <!-- Current Player Section -->
      <div class="player-section">
        <div class="player-header">
          <span class="player-name">{{ playService.currentPlayer()?.name }}</span>
          <ion-chip [color]="playService.currentPlayerOnBoard() ? 'success' : 'medium'" size="small">
            {{ playService.currentPlayerOnBoard() ? 'ON BOARD' : 'OFF BOARD' }}
          </ion-chip>
        </div>

        <div class="score-display">
          <div class="total-score">
            <span class="score-label">Total</span>
            <span class="score-value">{{ formatNumber(playService.currentPlayerTotal()) }}</span>
          </div>
          <div class="turn-score" [class.has-points]="playService.draftTurnPoints() > 0">
            <span class="score-label">This Turn</span>
            <span class="score-value">+{{ formatNumber(playService.draftTurnPoints()) }}</span>
          </div>
        </div>

        <!-- Target Progress -->
        <div class="target-progress">
          <div class="progress-bar">
            <div class="progress-fill"
                 [style.width.%]="(playService.currentPlayerTotal() / game.rules.targetScore) * 100">
            </div>
          </div>
          <span class="target-label">{{ formatNumber(game.rules.targetScore) }}</span>
        </div>
      </div>

      <!-- Draft Segments -->
      @if (playService.draftSegments().length > 0) {
        <div class="draft-section">
          <div class="draft-header">
            <span>Turn Points</span>
            <ion-button fill="clear" size="small" color="danger" (click)="clearDraft()">
              Clear All
            </ion-button>
          </div>
          <div class="draft-chips">
            @for (segment of playService.draftSegments(); track segment.at; let i = $index) {
              <ion-chip [color]="segment.source === 'carry_over' ? 'tertiary' : 'primary'">
                +{{ formatNumber(segment.points) }}
                @if (segment.source === 'carry_over') {
                  <ion-icon name="arrow-forward"></ion-icon>
                }
              </ion-chip>
            }
            <ion-button fill="clear" size="small" (click)="removeLastSegment()">
              <ion-icon slot="icon-only" name="backspace"></ion-icon>
            </ion-button>
          </div>
        </div>
      }

      <!-- Carry-Over Option -->
      @if (playService.carryOverAvailable()) {
        <div class="carry-over-section">
          <ion-button expand="block" fill="outline" color="tertiary" (click)="addCarryOver()">
            <ion-icon slot="start" name="arrow-forward"></ion-icon>
            Carry Over +{{ formatNumber(playService.carryOverAmount()) }}
            <span class="carry-over-from">(from {{ playService.lastBankPlayer()?.name }})</span>
          </ion-button>
        </div>
      }

      <!-- Score Presets -->
      <div class="presets-section">
        <div class="presets-grid">
          @for (preset of playService.settings()?.scorePresets || []; track preset) {
            <ion-button fill="outline" (click)="addPreset(preset)">
              +{{ formatNumber(preset) }}
            </ion-button>
          }
          <ion-button fill="outline" color="secondary" (click)="openCustomEntry()">
            Custom
          </ion-button>
        </div>
      </div>

      <!-- Bank Preview Warning -->
      @if (playService.draftTurnPoints() > 0) {
        @let preview = playService.getBankPreview();
        @if (!preview.canBank && preview.cantBankReason) {
          <div class="bank-warning">
            <ion-icon name="warning"></ion-icon>
            {{ preview.cantBankReason }}
          </div>
        }
        @if (preview.wouldOvershoot && preview.outcome === 'PENALTY') {
          <div class="bank-warning penalty">
            <ion-icon name="alert-circle"></ion-icon>
            Overshoots by {{ formatNumber(preview.exceededBy) }} - Will lose this turn!
          </div>
        }
      }
    </div>
  </ion-content>

  <ion-footer>
    <ion-toolbar>
      <!-- Details button -->
      <ion-button slot="start" fill="clear" color="secondary" [routerLink]="['detail']">
        <ion-icon slot="icon-only" name="stats-chart"></ion-icon>
      </ion-button>

      <!-- Bank & Bust buttons -->
      <div class="action-buttons">
        <ion-button
          color="danger"
          fill="solid"
          (click)="bust()">
          BUST
        </ion-button>
        <ion-button
          color="success"
          fill="solid"
          [disabled]="playService.draftTurnPoints() === 0 || !playService.getBankPreview().canBank"
          (click)="attemptBank()">
          BANK
        </ion-button>
      </div>

      <!-- Menu button -->
      <ion-button slot="end" fill="clear" color="secondary" id="present-menu">
        <ion-icon slot="icon-only" name="menu"></ion-icon>
      </ion-button>
      <ion-action-sheet
        trigger="present-menu"
        (ionActionSheetDidDismiss)="handleActionSheetDidDismiss($event)"
        [buttons]="actionSheetButtons"/>
    </ion-toolbar>
  </ion-footer>

  <!-- Custom Entry Modal -->
  <ion-modal [isOpen]="isCustomEntryModalOpen"
             (didDismiss)="isCustomEntryModalOpen = false"
             style="--height: auto; --width: 90%; --max-width: 400px;">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Custom Score</ion-title>
          <ion-button slot="end" fill="clear" (click)="isCustomEntryModalOpen = false">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-toolbar>
      </ion-header>
      <div class="ion-padding">
        <ion-item>
          <ion-input
            type="number"
            label="Points"
            labelPlacement="floating"
            [value]="customEntryValue()"
            (ionInput)="customEntryValue.set($any($event.target).value)">
          </ion-input>
        </ion-item>
        <ion-button expand="block" class="ion-margin-top" (click)="submitCustomEntry()">
          Add Points
        </ion-button>
      </div>
    </ng-template>
  </ion-modal>

  <!-- Penalty Preview Modal -->
  <ion-modal [isOpen]="isPenaltyPreviewModalOpen"
             [backdropDismiss]="false"
             style="--height: auto; --width: 90%; --max-width: 400px;">
    <ng-template>
      <ion-header>
        <ion-toolbar color="danger">
          <ion-title>Overshoot Penalty!</ion-title>
        </ion-toolbar>
      </ion-header>
      <div class="ion-padding">
        @if (bankPreview(); as preview) {
          <div class="penalty-details">
            <p>Banking {{ formatNumber(preview.turnPoints) }} would exceed the target by {{ formatNumber(preview.exceededBy) }}.</p>
            <p><strong>You will lose all points from this turn.</strong></p>
            <p>Your total will remain at {{ formatNumber(playService.currentPlayerTotal()) }}.</p>
          </div>
        }
        <div class="penalty-actions">
          <ion-button expand="block" color="medium" (click)="cancelPenaltyPreview()">
            Go Back
          </ion-button>
          <ion-button expand="block" color="danger" (click)="confirmBank()">
            Accept Penalty
          </ion-button>
        </div>
      </div>
    </ng-template>
  </ion-modal>

}
